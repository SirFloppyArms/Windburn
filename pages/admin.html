<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>News Admin Panel - Windburn Multi-Sport Academy</title>
  <link rel="stylesheet" href="../styles/global.css" />
  <link rel="stylesheet" href="../components/header/header.css" />
  <link rel="stylesheet" href="../components/footer/footer.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 1rem;
    }

    .admin-header h1 {
      margin: 0;
      font-size: 2rem;
    }

    .logout-btn {
      background: #d32f2f;
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }

    .logout-btn:hover {
      background: #b71c1c;
    }

    /* Login Form */
    .login-container {
      max-width: 400px;
      margin: 4rem auto;
      padding: 2rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .login-container h2 {
      text-align: center;
      margin-bottom: 2rem;
      color: #333;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #333;
    }

    .form-group input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      box-sizing: border-box;
    }

    .form-group input:focus {
      outline: none;
      border-color: #1976d2;
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
    }

    .login-btn {
      width: 100%;
      padding: 0.75rem;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }

    .login-btn:hover {
      background: #1565c0;
    }

    .error-message {
      color: #d32f2f;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: #ffebee;
      border-radius: 4px;
    }

    /* Admin Panel */
    .admin-panel {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    .news-form {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .news-form h2 {
      margin-bottom: 1.5rem;
      color: #333;
    }

    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      font-family: inherit;
      box-sizing: border-box;
      resize: vertical;
      min-height: 100px;
    }

    .form-group textarea:focus {
      outline: none;
      border-color: #1976d2;
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .submit-btn {
      width: 100%;
      padding: 0.75rem;
      background: #388e3c;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 1rem;
    }

    .submit-btn:hover {
      background: #2e7d32;
    }

    .submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .news-list {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .news-list h2 {
      margin-bottom: 1.5rem;
      color: #333;
    }

    .news-item {
      padding: 1.5rem;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      margin-bottom: 1rem;
      background: #f9f9f9;
    }

    .news-item-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 0.5rem;
    }

    .news-item h3 {
      margin: 0;
      color: #333;
      font-size: 1.1rem;
    }

    .news-item-date {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .news-item-excerpt {
      color: #666;
      margin: 0.5rem 0;
    }

    .news-item-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .edit-btn, .delete-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .edit-btn {
      background: #1976d2;
      color: white;
    }

    .edit-btn:hover {
      background: #1565c0;
    }

    .delete-btn {
      background: #d32f2f;
      color: white;
    }

    .delete-btn:hover {
      background: #b71c1c;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .success-message {
      color: #388e3c;
      background: #e8f5e9;
      padding: 0.75rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }

    @media (max-width: 768px) {
      .admin-panel {
        grid-template-columns: 1fr;
      }

      .admin-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div id="header-placeholder"></div>

  <!-- PAGE HERO -->
  <section class="page-hero">
    <div class="page-hero__content">
      <h1>News Management Admin</h1>
      <p class="page-hero__subtitle">Create, edit, and manage news articles for Windburn Multi-Sport Academy</p>
    </div>
  </section>

  <!-- LOGIN VIEW -->
  <div id="login-view" style="display: none;">
    <div class="login-container">
      <h2>Admin Login</h2>
      <div id="login-error" class="error-message" style="display: none;"></div>
      <form id="login-form">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" required placeholder="dave@windburn.local or admin@windburn.local">
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" required placeholder="Enter your password">
        </div>
        <button type="submit" class="login-btn">Login</button>
      </form>
      <p style="text-align: center; margin-top: 1rem; color: #666; font-size: 0.9rem;">
        Default credentials:<br>
        Email: dave@windburn.local or admin@windburn.local<br>
        Password: windburn123
      </p>
    </div>
  </div>

  <!-- ADMIN PANEL VIEW -->
  <div id="admin-view" style="display: none;">
    <div class="admin-container">
      <div class="admin-header">
        <div>
          <h1>News Admin Panel</h1>
          <p id="user-info" style="margin: 0; color: #666;"></p>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>

      <div id="success-message" class="success-message" style="display: none;"></div>

      <div class="admin-panel">
        <!-- News Form -->
        <div class="news-form">
          <h2 id="form-title">Create News Article</h2>
          <form id="news-form">
            <div class="form-group">
              <label for="title">Title</label>
              <input type="text" id="title" name="title" required placeholder="News article title">
            </div>
            
            <div class="form-group">
              <label for="excerpt">Excerpt</label>
              <textarea id="excerpt" name="excerpt" required placeholder="Short summary (appears in news list)"></textarea>
            </div>

            <div class="form-group">
              <label for="content">Full Content (optional)</label>
              <textarea id="content" name="content" placeholder="Full article content"></textarea>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="month">Month</label>
                <input type="text" id="month" name="month" placeholder="e.g., Jan" maxlength="3">
              </div>
              <div class="form-group">
                <label for="day">Day</label>
                <input type="number" id="day" name="day" placeholder="1-31" min="1" max="31">
              </div>
            </div>

            <div class="form-group">
              <label for="link">Link (optional)</label>
              <input type="text" id="link" name="link" placeholder="e.g., /src/pages/sub-pages/register.html">
            </div>

            <button type="submit" id="submit-btn" class="submit-btn">Create News Article</button>
            <button type="button" id="cancel-edit" class="logout-btn" style="display: none; margin-top: 0.75rem; background: #666;">Cancel Edit</button>
          </form>
        </div>

        <!-- News List -->
        <div class="news-list">
          <h2>Recent News Articles</h2>
          <div id="news-items" class="loading">Loading articles...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <div id="footer-placeholder"></div>

  <script>
    const API_URL = 'http://localhost:3001/api';
    let token = localStorage.getItem('adminToken');
    let currentUser = localStorage.getItem('currentUser') ? JSON.parse(localStorage.getItem('currentUser')) : null;
    let newsCache = [];
    let editingId = null;

    // Initialize page
    function initPage() {
      if (token) {
        showAdminPanel();
        loadNews();
      } else {
        showLoginForm();
      }
    }

    function showLoginForm() {
      document.getElementById('login-view').style.display = 'block';
      document.getElementById('admin-view').style.display = 'none';
      document.getElementById('login-form').addEventListener('submit', handleLogin);
    }

    function showAdminPanel() {
      document.getElementById('login-view').style.display = 'none';
      document.getElementById('admin-view').style.display = 'block';
      document.getElementById('user-info').textContent = `Logged in as: ${currentUser?.name || 'Admin'}`;
      document.getElementById('news-form').addEventListener('submit', handleCreateNews);
      document.getElementById('cancel-edit').addEventListener('click', cancelEdit);
    }

    // Handle login
    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('login-error');

      try {
        const response = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (!response.ok) {
          errorDiv.textContent = data.error || 'Login failed';
          errorDiv.style.display = 'block';
          return;
        }

        token = data.token;
        currentUser = data.user;
        localStorage.setItem('adminToken', token);
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        errorDiv.style.display = 'none';
        document.getElementById('login-form').reset();
        showAdminPanel();
        loadNews();
      } catch (err) {
        errorDiv.textContent = 'Connection error. Make sure the server is running on http://localhost:3001';
        errorDiv.style.display = 'block';
      }
    }

    // Logout
    function logout() {
      localStorage.removeItem('adminToken');
      localStorage.removeItem('currentUser');
      token = null;
      currentUser = null;
      document.getElementById('news-form').reset();
      initPage();
    }

    // Load news articles
    async function loadNews() {
      const container = document.getElementById('news-items');
      
      try {
        const response = await fetch(`${API_URL}/news`);
        const news = await response.json();
        newsCache = news;

        if (news.length === 0) {
          container.innerHTML = '<p style="color: #999;">No news articles yet.</p>';
          return;
        }

        container.innerHTML = news.map(item => `
          <div class="news-item">
            <div class="news-item-header">
              <h3>${item.title}</h3>
            </div>
            <div class="news-item-date">${item.month} ${item.day} â€¢ By ${item.author}</div>
            <p class="news-item-excerpt">${item.excerpt}</p>
            <div class="news-item-actions">
              <button class="edit-btn" onclick="editNews(${item.id})">Edit</button>
              <button class="delete-btn" onclick="deleteNews(${item.id})">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        container.innerHTML = '<p style="color: #d32f2f;">Error loading articles.</p>';
      }
    }

    // Create news
    function getFormValues() {
      const dayValue = document.getElementById('day').value;
      return {
        title: document.getElementById('title').value.trim(),
        excerpt: document.getElementById('excerpt').value.trim(),
        content: document.getElementById('content').value.trim(),
        month: document.getElementById('month').value.trim(),
        day: dayValue ? parseInt(dayValue, 10) : undefined,
        link: document.getElementById('link').value.trim()
      };
    }

    function setFormMode(mode, article = null) {
      const formTitle = document.getElementById('form-title');
      const submitBtn = document.getElementById('submit-btn');
      const cancelBtn = document.getElementById('cancel-edit');

      if (mode === 'edit' && article) {
        editingId = article.id;
        formTitle.textContent = 'Edit News Article';
        submitBtn.textContent = 'Update News Article';
        cancelBtn.style.display = 'block';

        document.getElementById('title').value = article.title || '';
        document.getElementById('excerpt').value = article.excerpt || '';
        document.getElementById('content').value = article.content || '';
        document.getElementById('month').value = article.month || '';
        document.getElementById('day').value = article.day || '';
        document.getElementById('link').value = article.link || '';
      } else {
        editingId = null;
        formTitle.textContent = 'Create News Article';
        submitBtn.textContent = 'Create News Article';
        cancelBtn.style.display = 'none';
        document.getElementById('news-form').reset();
      }
    }

    function cancelEdit() {
      setFormMode('create');
    }

    async function handleCreateNews(e) {
      e.preventDefault();
      const submitBtn = document.querySelector('.submit-btn');
      submitBtn.disabled = true;

      const values = getFormValues();
      const isEdit = Boolean(editingId);

      const formData = {
        title: values.title,
        excerpt: values.excerpt,
        content: values.content || values.excerpt,
        link: values.link
      };

      if (isEdit) {
        if (values.month) formData.month = values.month;
        if (values.day !== undefined) formData.day = values.day;
      } else {
        formData.month = values.month || new Date().toLocaleDateString('en-US', { month: 'short' });
        formData.day = values.day !== undefined ? values.day : new Date().getDate();
      }

      try {
        const endpoint = isEdit ? `${API_URL}/news/${editingId}` : `${API_URL}/news`;
        const method = isEdit ? 'PUT' : 'POST';

        const response = await fetch(endpoint, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          throw new Error('Failed to create news');
        }

        // Show success message
        const successDiv = document.getElementById('success-message');
        successDiv.textContent = isEdit ? 'News article updated successfully!' : 'News article created successfully!';
        successDiv.style.display = 'block';
        setTimeout(() => { successDiv.style.display = 'none'; }, 3000);

        setFormMode('create');
        loadNews();
      } catch (err) {
        alert('Error creating news: ' + err.message);
      } finally {
        submitBtn.disabled = false;
      }
    }

    // Delete news
    async function deleteNews(id) {
      if (!confirm('Are you sure you want to delete this article?')) return;

      try {
        const response = await fetch(`${API_URL}/news/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to delete');

        loadNews();
      } catch (err) {
        alert('Error deleting news');
      }
    }

    // Edit news (simplified - sets form values)
    function editNews(id) {
      const article = newsCache.find(item => item.id === id);
      if (!article) return;
      setFormMode('edit', article);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Load header and footer
    fetch("../components/header.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("header-placeholder").innerHTML = data;
        initStickyHeader();
        initPhoneMenu();
      });

    fetch("../components/footer.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("footer-placeholder").innerHTML = data;
      });

    // Initialize
    initPage();
  </script>
</body>
</html>
